name: Frontend CI/CD

on:
  push:
    branches: [ "master" ]   # æ ¹æ®å®é™…é»˜è®¤åˆ†æ”¯è°ƒæ•´
  workflow_dispatch:          # å…è®¸æ‰‹åŠ¨è§¦å‘

# ---------------------------------------------
# å¿…è¦ Secretsï¼ˆåœ¨ä»“åº“ Settings â†’ Secrets and variables â†’ Actions è®¾ç½®ï¼‰
#   SSH_HOST      æœåŠ¡å™¨ IP / åŸŸå
#   SSH_PORT      SSH ç«¯å£ï¼Œé»˜è®¤ 22
#   SSH_USER      ç™»å½•ç”¨æˆ·ï¼Œå¦‚ deploy
#   SSH_KEY       ç§é’¥å…¨æ–‡ï¼ˆed25519 æˆ– rsaï¼‰
#   TARGET_DIR    éƒ¨ç½²ç›®å½•ï¼Œå¦‚ /www/zeno/frontend/dist    (å¯é€‰: é»˜è®¤åŒä¸‹)
# ---------------------------------------------

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read   # æœ€å°æƒé™åŸåˆ™

    steps:
      # 1. æ‹‰å–æºç 
      - name: Checkout source
        uses: actions/checkout@v4

      # 2. è®¾ç½® Node.js & ç¼“å­˜ä¾èµ–
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # 3. å®‰è£…ä¾èµ–å¹¶æ„å»º
      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      # 4. å‹ç¼© dist ç›®å½•ï¼Œå‡å°‘ä¼ è¾“ä½“ç§¯
      - name: Compress dist folder
        run: |
          tar -czf dist.tar.gz -C dist .

      # 5. ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨ (é€šè¿‡ scp)
      - name: Upload dist.tar.gz to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          source: "dist.tar.gz"
          target: "/tmp"   # ä¸´æ—¶ç›®å½•

      # 6. åœ¨æœåŠ¡å™¨ç«¯è§£å‹å¹¶é‡è½½ Nginx
      - name: Deploy on server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            DEPLOY_DIR="${{ secrets.TARGET_DIR }}"
            if [ -z "$DEPLOY_DIR" ]; then
              DEPLOY_DIR="/www/zeno/frontend/dist"
            fi
            sudo mkdir -p "$DEPLOY_DIR"
            sudo tar -xzf /tmp/dist.tar.gz -C "$DEPLOY_DIR" --strip-components=0
            sudo rm -f /tmp/dist.tar.gz
            # å¦‚æœ‰éœ€è¦ï¼Œå¯è½¯åˆ é™¤æ—§ç‰ˆæœ¬æˆ–åšä¸€äº›å¤‡ä»½å¤„ç†
            # é‡æ–°åŠ è½½ Nginx ï¼ˆç¡®ä¿ ssh ç”¨æˆ·æœ‰ sudo æƒé™æˆ–åˆ æ‰ sudoï¼‰
            sudo systemctl reload nginx
            echo "ğŸš€  Frontend deployed to $DEPLOY_DIR"

