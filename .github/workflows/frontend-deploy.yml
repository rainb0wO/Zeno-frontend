name: Frontend CI/CD

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # 1. æ‹‰å–æºç 
      - name: Checkout source
        uses: actions/checkout@v4

      # 2. è®¾ç½® Node.js & ç¼“å­˜ä¾èµ–
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # 3. å®‰è£…ä¾èµ–å¹¶æ„å»º
      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      # 4. å‹ç¼© dist ç›®å½•
      - name: Compress dist folder
        run: |
          tar -czf dist.tar.gz -C dist .

      # 5. ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨
      - name: Upload dist.tar.gz to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          source: "dist.tar.gz"
          target: "/tmp"

      # 6. åœ¨æœåŠ¡å™¨ç«¯æ¸…ç©ºç›®æ ‡ç›®å½•å¹¶è§£å‹æ–°æ–‡ä»¶
      - name: Deploy on server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            DEPLOY_DIR="${{ secrets.TARGET_DIR }}"
            if [ -z "$DEPLOY_DIR" ]; then
              DEPLOY_DIR="/www/zeno/frontend/dist"
            fi
            
            # åˆ›å»ºéƒ¨ç½²ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            sudo mkdir -p "$DEPLOY_DIR"
            
            # æ¸…ç©ºç›®å½•ï¼ˆä¿ç•™ç›®å½•æœ¬èº«ï¼‰
            echo "ğŸ§¹ æ¸…ç†æ—§æ–‡ä»¶..."
            sudo find "$DEPLOY_DIR" -mindepth 1 -delete
            
            # è§£å‹æ–°æ–‡ä»¶
            echo "ğŸš€ è§£å‹æ–°ç‰ˆæœ¬..."
            sudo tar -xzf /tmp/dist.tar.gz -C "$DEPLOY_DIR" --strip-components=0
            
            # è®¾ç½®æ­£ç¡®çš„æƒé™
            echo "ğŸ”’ è®¾ç½®æƒé™..."
            sudo chown -R www-data:www-data "$DEPLOY_DIR"
            sudo chmod -R 755 "$DEPLOY_DIR"
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            sudo rm -f /tmp/dist.tar.gz
            
            # é‡æ–°åŠ è½½ Nginx
            echo "ï¿½ï¿½ é‡æ–°åŠ è½½ Nginx..."
            sudo systemctl reload nginx || true
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"