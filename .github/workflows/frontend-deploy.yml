name: Frontend CI/CD

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # 1. 拉取源码
      - name: Checkout source
        uses: actions/checkout@v4

      # 2. 设置 Node.js & 缓存依赖
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # 3. 安装依赖并构建
      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      # 4. 压缩 dist 目录
      - name: Compress dist folder
        run: |
          tar -czf dist.tar.gz -C dist .

      # 5. 上传文件到服务器
      - name: Upload dist.tar.gz to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          source: "dist.tar.gz"
          target: "/tmp"

      # 6. 在服务器端清空目标目录并解压新文件
      - name: Deploy on server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            DEPLOY_DIR="${TARGET_DIR:-/www/zeno/frontend/dist}"
            
            # 创建部署目录（如果不存在）
            sudo mkdir -p "$DEPLOY_DIR"
            
            # 清空目录（保留目录本身）
            echo "==> 清理旧文件"
            sudo find "$DEPLOY_DIR" -mindepth 1 -delete
            
            # 解压新文件
            echo "==> 解压新版本"
            sudo tar -xzf /tmp/dist.tar.gz -C "$DEPLOY_DIR" --strip-components=0
            
            # 设置正确的权限
            echo "==> 设置权限"
            sudo chown -R nginx:nginx "$DEPLOY_DIR"
            sudo chmod -R 755 "$DEPLOY_DIR"
            
            # 清理临时文件
            sudo rm -f /tmp/dist.tar.gz
            
            # 重新加载 Nginx
            echo "�� 重新加载 Nginx..."
            sudo systemctl reload nginx || true
            
            echo "✅ 部署完成！"